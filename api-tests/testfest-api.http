### Init - fetch CSRF token
GET http://localhost:3000/
Accept: text/html

> {%
let headers = response.headers;
if (headers && headers.headers) headers = headers.headers;
let cookies = headers['set-cookie'];
if (Array.isArray(cookies)) cookies = cookies.join(';');
const setCookie = cookies || '';
const m = setCookie.match(/XSRF-TOKEN=([^;]+)/);
if (m) {
  client.global.set('csrfToken', decodeURIComponent(m[1]));
} else {
  console.log('CSRF Token not found in cookies:', setCookie);
}
client.global.set('timestamp', Date.now().toString());
%}

### System - Health Check
GET http://localhost:3000/health
Accept: application/json

> {%
if (response.status !== 200) {
  throw new Error(`Expected 200, got ${response.status}`);
}
%}

### Auth - Get Current User
GET http://localhost:3000/me
Accept: application/json

> {%
if (response.status !== 200) {
  throw new Error(`Expected 200, got ${response.status}`);
}
%}

### Auth - SSO Login (redirect)
# @no-redirect
GET http://localhost:3000/auth/login

> {%
if (response.status !== 302) {
  throw new Error(`Expected 302 redirect, got ${response.status}`);
}
%}

### Auth - Logout
POST http://localhost:3000/auth/logout
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const body = response.body;
if (!body.ok) throw new Error('Logout did not return ok');
%}

### Rooms - Get Script Library
GET http://localhost:3000/api/script-library
Accept: application/json

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const json = response.body;
if (json.length > 0) {
  client.global.set('scriptId', json[0].id);
}
%}

### Rooms - Get All Rooms
GET http://localhost:3000/api/rooms
Accept: application/json

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);

let headers = response.headers;
if (headers && headers.headers) headers = headers.headers;
let cookies = headers['set-cookie'];
if (Array.isArray(cookies)) cookies = cookies.join(';');
const setCookie = cookies || '';
const m = setCookie.match(/XSRF-TOKEN=([^;]+)/);
if (m) {
  client.global.set('csrfToken', decodeURIComponent(m[1]));
}
%}

### Rooms - Create Room
POST http://localhost:3000/api/rooms
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{
  "name": "Test Room {{timestamp}}",
  "description": "API test room created via httpyac",
  "scriptId": "{{scriptId}}"
}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const json = response.body;
if (!json.id) throw new Error('Expected room id in response');
client.global.set('roomId', json.id);

let headers = response.headers;
if (headers && headers.headers) headers = headers.headers;
let cookies = headers['set-cookie'];
if (Array.isArray(cookies)) cookies = cookies.join(';');
const setCookie = cookies || '';
const m = setCookie.match(/XSRF-TOKEN=([^;]+)/);
if (m) {
  client.global.set('csrfToken', decodeURIComponent(m[1]));
}
%}

### Rooms - Join Room
POST http://localhost:3000/api/rooms/{{roomId}}/join
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);

let headers = response.headers;
if (headers && headers.headers) headers = headers.headers;
let cookies = headers['set-cookie'];
if (Array.isArray(cookies)) cookies = cookies.join(';');
const setCookie = cookies || '';
const m = setCookie.match(/XSRF-TOKEN=([^;]+)/);
if (m) {
  client.global.set('csrfToken', decodeURIComponent(m[1]));
}
%}

### Rooms - Get Test Script Lines
GET http://localhost:3000/api/rooms/{{roomId}}/test-script-lines
Accept: application/json

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const json = response.body;
if (json.length > 0) {
  client.global.set('testScriptLineId', json[0].id);
  client.global.set('scriptLineNum', json[0].test_script_line_id);
}
%}

### Rooms - Update Test Script Progress
POST http://localhost:3000/api/test-script-lines/{{testScriptLineId}}/progress
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{
  "is_checked": true,
  "notes": "Test completed successfully"
}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Get Room Issues
GET http://localhost:3000/api/rooms/{{roomId}}/issues
Accept: application/json

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Create Issue (form-data)
POST http://localhost:3000/api/rooms/{{roomId}}/issues
X-XSRF-TOKEN: {{csrfToken}}
Content-Type: multipart/form-data; boundary=WebKitFormBoundary7MA4YWxkTrZu0gW

--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="scriptId"

{{scriptLineNum}}
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="description"

Test issue created via httpyac
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_issue"

true
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_annoyance"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_existing_upper_env"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_not_sure_how_to_test"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW--

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const json = response.body;
if (!json.id) throw new Error('Expected issue id');
client.global.set('issueId', json.id);

let headers = response.headers;
if (headers && headers.headers) headers = headers.headers;
let cookies = headers['set-cookie'];
if (Array.isArray(cookies)) cookies = cookies.join(';');
const setCookie = cookies || '';
const m = setCookie.match(/XSRF-TOKEN=([^;]+)/);
if (m) {
  client.global.set('csrfToken', decodeURIComponent(m[1]));
}
%}

### Issues - Create Issue with Images (skipped file upload in automated test)
POST http://localhost:3000/api/rooms/{{roomId}}/issues
X-XSRF-TOKEN: {{csrfToken}}
Content-Type: multipart/form-data; boundary=WebKitFormBoundary7MA4YWxkTrZu0gW

--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="scriptId"

{{scriptLineNum}}
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="description"

Issue with screenshot attachments
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_issue"

true
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_annoyance"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_existing_upper_env"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="is_not_sure_how_to_test"

false
--WebKitFormBoundary7MA4YWxkTrZu0gW--

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Update Issue Status
POST http://localhost:3000/api/issues/{{issueId}}/status
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{
  "status": "duplicate",
  "roomId": "{{roomId}}"
}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Clear Issue Status
POST http://localhost:3000/api/issues/{{issueId}}/status
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{
  "status": "clear-status",
  "roomId": "{{roomId}}"
}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Create Jira Ticket
POST http://localhost:3000/api/issues/{{issueId}}/jira
Content-Type: application/json
X-XSRF-TOKEN: {{csrfToken}}

{
  "roomId": "{{roomId}}"
}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
%}

### Issues - Delete Issue
DELETE http://localhost:3000/api/issues/{{issueId}}
X-XSRF-TOKEN: {{csrfToken}}

> {%
if (response.status !== 200) throw new Error(`Expected 200, got ${response.status}`);
const json = response.body;
if (!json.ok) throw new Error('Delete did not return ok');
%}
