image: atlassian/default-image:3

pipelines:
  branches:
    main:
      - step:
          name: Snyk Open Source & Code scan
          image: node:20
          caches:
            - node
          script:
            - npm ci
            - npm install -g snyk@latest
            - snyk auth ${SNYK_TOKEN}
            - snyk test --severity-threshold=${SNYK_SEVERITY_THRESHOLD:-medium}
            - snyk code test --severity-threshold=${SNYK_SEVERITY_THRESHOLD:-medium}
      - step:
          name: Build Docker image (artifact)
          services:
            - docker
          caches:
            - docker
          script:
            - export REPOSITORY="testfest-repo"
            - export TAG_COMMIT=${BITBUCKET_COMMIT}
            - export IMAGE="${REPOSITORY}:${TAG_COMMIT}"
            - docker build -t ${IMAGE} .
            - docker save ${IMAGE} -o image.tar
          artifacts:
            - image.tar
      - step:
          name: Snyk Container scan
          services:
            - docker
          caches:
            - docker
          script:
            - docker load -i image.tar
            - apk add --no-cache curl || true
            - curl -sL https://static.snyk.io/cli/latest/snyk-alpine -o /usr/local/bin/snyk && chmod +x /usr/local/bin/snyk
            - export REPOSITORY="testfest-repo"
            - export TAG_COMMIT=${BITBUCKET_COMMIT}
            - export IMAGE="${REPOSITORY}:${TAG_COMMIT}"
            - snyk auth ${SNYK_TOKEN}
            - snyk container test ${IMAGE} --file=Dockerfile --severity-threshold=${SNYK_SEVERITY_THRESHOLD:-medium}

definitions:
  caches:
    node: ~/.npm
  services:
    docker:
      memory: 3072
